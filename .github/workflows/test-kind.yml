name: Test Infrastructure on KinD

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup KinD
      uses: helm/kind-action@v1.10.0

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.x

    - name: Install Flux CLI
      run: |
        curl -s https://fluxcd.io/install.sh | sudo bash
        flux --version

    - name: Terraform Init
      run: terraform init

    - name: Terraform Apply
      run: terraform apply -auto-approve

    - name: Verify ArgoCD Installation
      run: |
        kubectl get all -n argocd
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server -n argocd --timeout=300s

    - name: Verify FluxCD Installation
      run: |
        flux get all -A
        kubectl wait --for=condition=ready pod -l app=source-controller -n flux-system --timeout=300s
        kubectl wait --for=condition=ready pod -l app=kustomize-controller -n flux-system --timeout=300s

    - name: Verify Nginx Application (ArgoCD Kustomize)
      run: |
        kubectl get deployment nginx -n default
        kubectl get service nginx -n default
        kubectl wait --for=condition=available deployment/nginx -n default --timeout=300s

    - name: Verify ArgoCD Helm App
      run: |
        argocd app list
        kubectl get deployment helm-nginx -n default
        kubectl wait --for=condition=available deployment/helm-nginx -n default --timeout=300s

    - name: Verify FluxCD Helm App
      run: |
        flux get kustomizations -A
        kubectl get deployment helm-nginx -n flux-system
        kubectl wait --for=condition=available deployment/helm-nginx -n flux-system --timeout=300s

    - name: Verify Nginx Application (FluxCD Kustomize)
      run: |
        kubectl get deployment nginx -n flux-system
        kubectl get service nginx -n flux-system
        kubectl wait --for=condition=available deployment/nginx -n flux-system --timeout=300s

    - name: Verify All Pods
      run: |
        kubectl get pods -n default
        kubectl get pods -n flux-system
